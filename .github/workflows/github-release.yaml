name: Release cuack

on:
  push:
    branches:
      - main
    tags:
      - '**'

jobs:
    release_demo_cuack:
      runs-on: ubuntu-latest
      # strategy:
      #   matrix:
      #     goos: [linux, windows]
      #     goarch: ["386", "amd64"]
      #     goos: [linux]
      #     goarch: [amd64]
      if: github.event_name == 'push'
      steps:
        - uses: actions/checkout@v2
          with:
            token: ${{ secrets.ACCESS_TOKEN_GITHUB }}

        - name: Get the version
          id: get_version
          run: echo ::set-output name=VERSION::$(echo $GITHUB_REF | cut -d / -f 3)


        - name: Build
          uses: actions/setup-go@v2
          with:
            go-version: '1.17' # The Go version to download (if necessary) and use.
        - run: go build -mod vendor -o ./bin/cuack-ctl ./cmd/cuack-ctl/

        - name: Create Release
          uses: actions/create-release@v1
          id: create_release
          with:
            draft: false
            prerelease: false
            release_name: ${{ steps.get_version.outputs.VERSION }}
            tag_name: ${{ steps.get_version.outputs.VERSION }}
          env:
            GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN_GITHUB }}

        - name: upload linux artifact
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN_GITHUB }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ./bin/cuack-ctl
            asset_name: cuack-ctl
            asset_content_type: application/octet-stream
